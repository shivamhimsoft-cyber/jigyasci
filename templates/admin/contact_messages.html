{% extends "base.html" %}
{% block title %}Contact Messages | JigyaSci Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Flash Messages Popup -->
    <div id="flash-messages" class="fixed top-4 right-4 z-50 w-80 max-w-full space-y-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flex items-start p-4 rounded-lg shadow-lg border transition-all duration-300 transform 
                                {% if category == 'success' %}bg-green-100 border-green-300 text-green-800{% endif %}
                                {% if category == 'error' %}bg-red-100 border-red-300 text-red-800{% endif %}
                                {% if category == 'warning' %}bg-yellow-100 border-yellow-300 text-yellow-800{% endif %}
                                flash-message animate-slide-in">
                        <div class="flex-shrink-0">
                            {% if category == 'success' %}
                                <i class="ti ti-check text-xl"></i>
                            {% elif category == 'error' %}
                                <i class="ti ti-alert-circle text-xl"></i>
                            {% elif category == 'warning' %}
                                <i class="ti ti-alert-triangle text-xl"></i>
                            {% endif %}
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium">{{ message }}</p>
                        </div>
                        <button onclick="dismissMessage(this)" class="ml-2 p-1 hover:bg-opacity-20 rounded-full focus:outline-none">
                            <i class="ti ti-x text-lg"></i>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="w-full card bg-white border border-gray-200 rounded-lg shadow-sm">
        <div class="card-body p-6">
            <div class="sm:flex items-center justify-between mb-6">
                <div>
                    <h5 class="text-xl font-semibold text-black mb-1">
                        <i class="fas fa-envelope me-2"></i>Contact Messages
                    </h5>
                    <p class="text-sm text-gray-600">Manage all contact messages and update their status</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 md:mt-0 mt-4">
                    <form class="relative">
                        <input type="text" id="search-input"
                               class="border border-black/80 rounded-sm px-4 py-1.5 pl-10 text-black placeholder-black/80 focus:ring-0 focus:outline-0 focus:border-black w-64"
                               placeholder="Search by email...">
                        <i class="ti ti-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </form>
                </div>
            </div>

            <div class="flex flex-col">
                <div id="table-container" class="overflow-auto cursor-grab">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">S. No.</th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-user me-1"></i>Name
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-comment me-1"></i>Subject
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-comments me-1"></i>Message
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-info-circle me-1"></i>Status
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-sticky-note me-1"></i>Remark
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-calendar me-1"></i>Created At
                                </th>
                                <th scope="col" class="text-center px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-cogs me-1"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="contact-messages-tbody" class="bg-white divide-y divide-gray-200">
                            {% if contact_messages.items %}
                                {% for message in contact_messages.items %}
                                <tr class="hover:bg-gray-50 transition-colors duration-150 contact-message-row" 
                                    data-message-id="{{ message.id }}" data-email="{{ message.email }}">
                                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-black serial-no">
                                        {{ (contact_messages.page - 1) * contact_messages.per_page + loop.index }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="text-sm text-black">{{ message.name }}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="max-w-xs">
                                            <span class="text-sm text-black break-words email-cell">
                                                {{ message.email }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-black break-words">{{ message.subject }}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="max-w-md">
                                            <span class="text-sm text-black break-words message-cell" title="{{ message.message }}">
                                                {{ message.message }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="badge px-2 py-1 rounded text-xs font-semibold 
                                            {% if message.status == 'Pending' %}bg-yellow-100 text-yellow-800{% endif %}
                                            {% if message.status == 'InProgress' %}bg-blue-100 text-blue-800{% endif %}
                                            {% if message.status == 'Resolved' %}bg-green-100 text-green-800{% endif %}">
                                            {{ message.status | default('Pending') }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="max-w-md">
                                            <span class="text-sm text-black break-words remark-cell" title="{{ message.remark if message.remark else 'No remarks' }}">
                                                {{ message.remark if message.remark else 'No remarks' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="text-sm text-black">{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            <select name="status" class="border rounded p-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 status-select" data-current-status="{{ message.status }}">
                                                <option value="Pending" {% if message.status == 'Pending' %}selected{% endif %}>Pending</option>
                                                <option value="InProgress" {% if message.status == 'InProgress' %}selected{% endif %}>In Progress</option>
                                                <option value="Resolved" {% if message.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                            </select>
                                            <input type="text" name="remark" placeholder="Add remark (optional)" 
                                                   value="{{ message.remark | default('') }}" class="border rounded p-1 w-32 text-sm" maxlength="200">
                                            <label class="flex items-center">
                                                <input type="checkbox" name="send_email" class="mr-1 send-email-checkbox" checked>
                                                <span class="text-sm text-gray-600">Send Email</span>
                                            </label>
                                            <button onclick="handleAction('{{ message.id }}', 'update', this)" 
                                                    class="update-btn p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-colors duration-200" 
                                                    title="Update">
                                                <i class="ti ti-check text-base"></i> Update
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr id="no-messages-row">
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="ti ti-mail text-4xl text-gray-300 mb-2"></i>
                                        <span class="text-sm">No contact messages found</span>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                {% if contact_messages.has_prev or contact_messages.has_next %}
                <div class="flex justify-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="inline-flex -space-x-px text-sm">
                            {% if contact_messages.has_prev %}
                            <li>
                                <a href="{{ url_for('admin.contact_messages', page=contact_messages.prev_num) }}" class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg hover:bg-gray-100 hover:text-gray-700">
                                    Previous
                                </a>
                            </li>
                            {% else %}
                            <li>
                                <span class="flex items-center justify-center px-3 h-8 ml-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-l-lg cursor-not-allowed">
                                    Previous
                                </span>
                            </li>
                            {% endif %}

                            {% for num in contact_messages.iter_pages() %}
                            {% if num %}
                                {% if num == contact_messages.page %}
                                <li>
                                    <span class="flex items-center justify-center px-3 h-8 leading-tight text-blue-600 border border-gray-300 bg-blue-50">{{ num }}</span>
                                </li>
                                {% else %}
                                <li>
                                    <a href="{{ url_for('admin.contact_messages', page=num) }}" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700">{{ num }}</a>
                                </li>
                                {% endif %}
                            {% else %}
                                <li>
                                    <span class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300">...</span>
                                </li>
                            {% endif %}
                            {% endfor %}

                            {% if contact_messages.has_next %}
                            <li>
                                <a href="{{ url_for('admin.contact_messages', page=contact_messages.next_num) }}" class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg hover:bg-gray-100 hover:text-gray-700">
                                    Next
                                </a>
                            </li>
                            {% else %}
                            <li>
                                <span class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-r-lg cursor-not-allowed">
                                    Next
                                </span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>

            <!-- Footer Info -->
            <div class="text-center pt-3 border-t border-gray-200 text-muted small">
                <i class="fas fa-info-circle me-1"></i>Update message status and add remarks. Check "Send Email" to notify users.
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for AJAX Actions, Search, and Animations -->
<script>
    // Global counter for serial numbers
    let serialCounter = {{ contact_messages.total or 0 }};

    // AJAX Action Handler (with confirm alert)
    function handleAction(messageId, action, button) {
        const row = document.querySelector(`.contact-message-row[data-message-id="${messageId}"]`);
        if (!row) return;

        const email = row.dataset.email;
        const confirmMessage = `Are you sure you want to update the status/remark for ${email}?`;
        
        if (!confirm(confirmMessage)) {
            return; // Cancel if user clicks "Cancel"
        }

        // Get form data from the row
        const statusSelect = row.querySelector('select[name="status"]');
        const remarkInput = row.querySelector('input[name="remark"]');
        const sendEmailCheckbox = row.querySelector('input[name="send_email"]');
        const newStatus = statusSelect ? statusSelect.value : '';
        const remark = remarkInput ? remarkInput.value : '';
        const sendEmail = sendEmailCheckbox ? sendEmailCheckbox.checked : false;

        const formData = new FormData();
        formData.append('status', newStatus);
        formData.append('remark', remark);
        formData.append('send_email', sendEmail);

        // Show loading state
        const updateBtn = row.querySelector('.update-btn');
        const originalText = updateBtn.innerHTML;
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="ti ti-loader-2 animate-spin text-base"></i> Processing...';

        fetch(`/admin/contact_messages/${messageId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update row data
                const statusBadge = row.querySelectorAll('.badge')[0]; // Target the first badge
                statusBadge.textContent = newStatus;
                statusBadge.className = `badge px-2 py-1 rounded text-xs font-semibold ${getStatusClasses(newStatus)}`;
                row.querySelector('.remark-cell').textContent = remark || 'No remarks';
                row.querySelector('.remark-cell').title = remark || 'No remarks'; // Update tooltip
                
                // Show success message
                showFlashMessage('success', `Updated status and remark for ${email} successfully.${data.message ? ' ' + data.message : ''}`);
            } else {
                showFlashMessage('error', data.message || 'Update failed. Please try again.');
            }
            // Reset button in both cases
            resetButton(updateBtn, originalText);
        })
        .catch(error => {
            console.error('Error:', error);
            showFlashMessage('error', 'Network error. Please try again.');
            resetButton(updateBtn, originalText);
        });
    }

    // Get status classes for badge
    function getStatusClasses(status) {
        const classes = {
            'Pending': 'bg-yellow-100 text-yellow-800',
            'InProgress': 'bg-blue-100 text-blue-800',
            'Resolved': 'bg-green-100 text-green-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }

    // Reset button after error
    function resetButton(button, originalText) {
        button.disabled = false;
        button.innerHTML = originalText;
    }

    // Search Functionality (client-side)
    document.getElementById('search-input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.contact-message-row');
        let visibleCount = 0;
        rows.forEach(row => {
            const email = row.querySelector('.email-cell').textContent.toLowerCase();
            if (email.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        // Update serial numbers for visible rows
        const visibleRows = document.querySelectorAll('.contact-message-row:not([style*="display: none"])');
        visibleRows.forEach((row, index) => {
            const serialCell = row.querySelector('.serial-no');
            if (serialCell) {
                serialCell.textContent = index + 1 + (({{ contact_messages.page - 1 }} || 0) * {{ contact_messages.per_page }});
            }
        });
        // Show no-messages-row if no matches
        const tbody = document.getElementById('contact-messages-tbody');
        const noMessagesRow = document.getElementById('no-messages-row');
        if (visibleCount === 0 && !noMessagesRow) {
            tbody.innerHTML = `
                <tr id="no-messages-row">
                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="ti ti-mail text-4xl text-gray-300 mb-2"></i>
                            <span class="text-sm">No contact messages found</span>
                        </div>
                    </td>
                </tr>
            `;
        } else if (visibleCount > 0 && noMessagesRow) {
            noMessagesRow.remove();
        }
    });

    // Flash Message Functions
    function showFlashMessage(category, message) {
        const flashContainer = document.getElementById('flash-messages') || createFlashContainer();
        const flashDiv = document.createElement('div');
        flashDiv.className = `flash-message flex items-start p-4 rounded-lg shadow-lg border transition-all duration-300 transform animate-slide-in ${getFlashClasses(category)}`;
        flashDiv.innerHTML = `
            <div class="flex-shrink-0">
                ${getFlashIcon(category)}
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium">${message}</p>
            </div>
            <button onclick="dismissMessage(this)" class="ml-2 p-1 hover:bg-opacity-20 rounded-full focus:outline-none">
                <i class="ti ti-x text-lg"></i>
            </button>
        `;
        flashContainer.appendChild(flashDiv);
        setTimeout(() => dismissMessage(flashDiv.querySelector('button')), 5000);
    }

    function createFlashContainer() {
        const container = document.createElement('div');
        container.id = 'flash-messages';
        container.className = 'fixed top-4 right-4 z-50 w-80 max-w-full space-y-3';
        document.body.appendChild(container);
        return container;
    }

    function getFlashClasses(category) {
        const classes = {
            success: 'bg-green-100 border-green-300 text-green-800',
            error: 'bg-red-100 border-red-300 text-red-800',
            warning: 'bg-yellow-100 border-yellow-300 text-yellow-800'
        };
        return classes[category] || 'bg-blue-100 border-blue-300 text-blue-800';
    }

    function getFlashIcon(category) {
        const icons = {
            success: '<i class="ti ti-check text-xl"></i>',
            error: '<i class="ti ti-alert-circle text-xl"></i>',
            warning: '<i class="ti ti-alert-triangle text-xl"></i>'
        };
        return icons[category] || '<i class="ti ti-info-circle text-xl"></i>';
    }

    function dismissMessage(button) {
        const message = button.closest('.flash-message');
        message.classList.remove('animate-slide-in');
        message.classList.add('animate-slide-out');
        setTimeout(() => message.remove(), 300);
    }

    // Auto-dismiss existing messages and initialize dropdowns
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure dropdown reflects current status
        document.querySelectorAll('.status-select').forEach(select => {
            const currentStatus = select.getAttribute('data-current-status') || 'Pending';
            select.value = currentStatus;
            // Force re-render to ensure dropdown is functional
            select.style.display = 'block';
            setTimeout(() => select.style.display = '', 0);
        });

        // Auto-dismiss existing messages
        const messages = document.querySelectorAll('.flash-message');
        messages.forEach((message) => {
            setTimeout(() => dismissMessage({ closest: () => message }), 5000);
        });
    });

    // Table Drag Scroll
    const container = document.getElementById('table-container');
    let isDown = false;
    let startX;
    let scrollLeft;

    container.addEventListener('mousedown', (e) => {
        // Prevent drag-scroll when clicking on interactive elements
        const target = e.target;
        if (
            e.button !== 0 ||
            target.tagName === 'SELECT' ||
            target.tagName === 'OPTION' ||
            target.tagName === 'INPUT' ||
            target.tagName === 'BUTTON' ||
            target.closest('select') ||
            target.closest('input') ||
            target.closest('button')
        ) {
            return; // Skip drag scroll
        }

        isDown = true;
        container.classList.add('cursor-grabbing');
        container.classList.remove('cursor-grab');
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
        e.preventDefault();
    });

    container.addEventListener('mouseleave', () => {
        isDown = false;
        container.classList.remove('cursor-grabbing');
        container.classList.add('cursor-grab');
    });

    container.addEventListener('mouseup', () => {
        isDown = false;
        container.classList.remove('cursor-grabbing');
        container.classList.add('cursor-grab');
    });

    container.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 1;
        container.scrollLeft = scrollLeft - walk;
    });
</script>

<!-- Styles -->
<style>
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    .animate-slide-out { animation: slideOut 0.3s ease-in forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    .flash-message { min-height: 3rem; display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .flash-message button:hover { background-color: rgba(0, 0, 0, 0.1); }
    .break-words { word-break: break-word; overflow-wrap: break-word; }
    .message-cell, .remark-cell { max-width: 100%; display: block; white-space: pre-wrap; }
    .badge { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
    .contact-message-row { transition: all 0.3s ease-out; }
    /* [title]:hover:after {
        content: attr(title);
        position: absolute;
        background-color: #333;
        color: #fff;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        z-index: 1000;
        white-space: normal;
        max-width: 300px;
        word-wrap: break-word;
        margin-top: -2.5rem;
        margin-left: 0.5rem;
    }
    [title] { position: relative; } */

    .status-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg fill='none' stroke='%23666' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
        padding-right: 2rem; /* create space for arrow */
    }

    .status-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
</style>
{% endblock %}