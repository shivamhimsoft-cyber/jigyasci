<!-- templates/admin/opportunities_modals.html -->
<div id="addLinkModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50 overflow-y-auto py-6">
    <div id="linkModalContent" 
         class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-auto my-8 transform scale-95 opacity-0 transition-all duration-300 max-h-[90vh] flex flex-col">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-5 pb-3 border-b flex-shrink-0">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-link mr-2 text-orange-500"></i>
                Add Opportunity Links
            </h3>
            <button type="button" onclick="closeAddLinkModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times-circle text-xl"></i>
            </button>
        </div>

        <!-- Scrollable Body -->
        <div class="flex-1 overflow-y-auto pr-2 modal-scroll">
            <form id="addLinkForm" class="space-y-6">
                <div id="linkFieldsContainer" class="space-y-6">
                    <!-- First Link Block (No Remove Button) -->
                    <div class="link-block border rounded-lg p-4 bg-gray-50">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Title -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                                <input type="text" name="title[]" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                       placeholder="Enter link title">
                            </div>

                            <!-- Link -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Link <span class="text-red-500">*</span></label>
                                <input type="url" name="link[]" required
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                       placeholder="https://example.com">
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mt-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea name="description[]" rows="3"
                                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                      placeholder="Brief description"></textarea>
                        </div>

                        <!-- Opportunity Types (Multiple Select Dropdown like Current Focus) -->
                        <div class="form-group mt-4">
                            <label class="block text-sm font-semibold text-black mb-2">Opportunity Types (Tags) *</label>
                            <div class="relative">
                                <!-- Dropdown button -->
                                <button type="button" onclick="toggleTagsDropdown(this)" 
                                        class="w-full flex items-center justify-between px-4 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200">
                                  <span id="tags-display-0">Select Opportunity Types</span>
                                  <span class="text-gray-500">(<span class="tag-count">0</span> selected) <i class="ti ti-chevron-down ml-1"></i></span>
                                </button>

                                <!-- Dropdown list -->
                                <div class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden transition-all duration-200 ease-in-out transform scale-95 opacity-0" id="tags-dropdown-0">
                                  {% for type in opportunity_types %}
                                  <label class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer transition-colors duration-150 border-b border-gray-100 last:border-b-0">
                                    <input type="checkbox" name="tags[]" value="{{ type.name }}"
                                           class="mr-3 rounded border-gray-300 focus:ring-orange-500 h-4 w-4 text-orange-600" 
                                           onchange="updateTagsCount(this)">
                                    <span class="font-normal">{{ type.name }}</span>
                                  </label>
                                  {% endfor %}
                                </div>
                            </div>
                            <small class="text-gray-600 mt-1 block">Select multiple opportunity types (Hold Ctrl/Cmd to select multiple)</small>
                        </div>
                    </div>
                </div>

                <!-- Add Another Link Button -->
                <div class="flex justify-start mt-4">
                    <button type="button" id="addAnotherLink" 
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center gap-2 transition-colors duration-200">
                        <i class="fas fa-plus"></i> Add Another Link
                    </button>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-3 pt-4 mt-4 border-t flex-shrink-0">
            <button type="button" onclick="closeAddLinkModal()" 
                    class="px-5 py-2.5 text-gray-600 hover:text-gray-800 font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors duration-200">
                Cancel
            </button>
            <button type="button" id="submitLinksBtn"
                    class="px-5 py-2.5 bg-gray-400 text-black font-medium rounded-lg hover:bg-orange-700 flex items-center gap-2 transition-colors duration-200">
                <i class="fas fa-plus"></i>
                Add Links
            </button>
        </div>
    </div>
</div>

<script>
// Store the first block HTML for resetting
let firstBlockHTML = '';
let blockCounter = 0;

// Initialize modal when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Store the first block HTML
    firstBlockHTML = document.querySelector('.link-block')?.outerHTML || '';
    
    // Initialize event listeners
    initLinkModal();
});

function initLinkModal() {
    // Add another link block
    const addAnotherBtn = document.getElementById('addAnotherLink');
    if (addAnotherBtn) {
        addAnotherBtn.addEventListener('click', function() {
            addNewLinkBlock();
        });
    }

    // Remove block (using proper event delegation)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-link')) {
            removeLinkBlock(e.target.closest('.link-block'));
        }
    });

    // Submit form
    const submitBtn = document.getElementById('submitLinksBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', async function() {
            await submitLinksForm();
        });
    }
}

// Add new link block function
function addNewLinkBlock() {
    const container = document.getElementById('linkFieldsContainer');
    if (!container || !firstBlockHTML) {
        console.error('Container or firstBlockHTML not found');
        return;
    }

    blockCounter++;

    const newBlock = document.createElement('div');
    newBlock.className = 'link-block border rounded-lg p-4 relative bg-gray-50';
    newBlock.innerHTML = firstBlockHTML.replace(/tags-display-\d+/g, `tags-display-${blockCounter}`).replace(/tags-dropdown-\d+/g, `tags-dropdown-${blockCounter}`).replace(/tag-count/g, `tag-count-${blockCounter}`);

    // Add remove button to new block
    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.className = 'remove-link absolute top-2 right-2 text-red-500 hover:text-red-700 bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-md z-10';
    removeButton.innerHTML = '<i class="fas fa-times text-sm"></i>';
    removeButton.onclick = function() { removeLinkBlock(newBlock); };
    newBlock.appendChild(removeButton);
    
    // Clear the input values in the new block
    const inputs = newBlock.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        if (input.type !== 'button') {
            input.value = '';
        }
    });

    // Reset tags dropdown for new block
    const newTagsDisplay = newBlock.querySelector(`#tags-display-${blockCounter}`);
    const newTagsDropdown = newBlock.querySelector(`#tags-dropdown-${blockCounter}`);
    const newTagCount = newBlock.querySelector(`.tag-count-${blockCounter}`);
    if (newTagsDisplay) newTagsDisplay.textContent = 'Select Opportunity Types';
    if (newTagCount) newTagCount.textContent = '0';
    if (newTagsDropdown) {
        const checkboxes = newTagsDropdown.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
    }
    
    container.appendChild(newBlock);
    console.log('New link block added with remove button'); // Debugging
}

// Remove link block function
function removeLinkBlock(block) {
    const blocks = document.querySelectorAll('.link-block');
    if (blocks.length > 1) {
        block.remove();
        console.log('Link block removed'); // Debugging
    } else {
        // Clear fields of the only block
        const inputs = block.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            if (input.type !== 'button') {
                input.value = '';
            }
        });

        // Reset tags dropdown
        const tagsDisplay = block.querySelector('#tags-display-0');
        const tagCount = block.querySelector('.tag-count');
        const tagsDropdown = block.querySelector('#tags-dropdown-0');
        if (tagsDisplay) tagsDisplay.textContent = 'Select Opportunity Types';
        if (tagCount) tagCount.textContent = '0';
        if (tagsDropdown) {
            const checkboxes = tagsDropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        showNotification('info', 'Cannot remove the last link block. Fields cleared instead.');
    }
}

// Toggle tags dropdown for a specific block
function toggleTagsDropdown(button) {
    const block = button.closest('.link-block');
    const dropdownId = block.querySelector('[id^="tags-dropdown-"]')?.id || 'tags-dropdown-0';
    const dropdown = document.getElementById(dropdownId);
    
    if (!dropdown) return;

    // Close other dropdowns
    document.querySelectorAll('[id^="tags-dropdown-"]').forEach(dd => {
        if (dd.id !== dropdownId) {
            dd.classList.add('hidden');
            dd.classList.remove('scale-100', 'opacity-100');
            dd.classList.add('scale-95', 'opacity-0');
        }
    });

    dropdown.classList.toggle('hidden');
    if (!dropdown.classList.contains('hidden')) {
        dropdown.classList.remove('scale-95', 'opacity-0');
        dropdown.classList.add('scale-100', 'opacity-100');
        dropdown.focus(); // For accessibility
    } else {
        dropdown.classList.remove('scale-100', 'opacity-100');
        dropdown.classList.add('scale-95', 'opacity-0');
    }
}

// Update tags count and display for a specific block
function updateTagsCount(checkbox) {
    const block = checkbox.closest('.link-block');
    const dropdownId = block.querySelector('[id^="tags-dropdown-"]')?.id || 'tags-dropdown-0';
    const displayId = block.querySelector('[id^="tags-display-"]')?.id || 'tags-display-0';
    const countSpan = block.querySelector('.tag-count') || block.querySelector(`.tag-count-${blockCounter}`);
    
    const dropdown = document.getElementById(dropdownId);
    const display = document.getElementById(displayId);
    
    if (!dropdown || !display || !countSpan) return;

    const selectedCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const count = selectedCheckboxes.length;
    countSpan.textContent = count;

    if (count === 0) {
        display.textContent = 'Select Opportunity Types';
    } else if (count === 1) {
        const selectedLabel = selectedCheckboxes[0].nextElementSibling.textContent.trim();
        display.textContent = selectedLabel;
    } else {
        display.textContent = `${count} types selected`;
    }
}

// Open add link modal
function openAddLinkModal() {
    const modal = document.getElementById('addLinkModal');
    const content = document.getElementById('linkModalContent');
    
    if (!modal || !content) {
        console.error('Add modal or content not found');
        return;
    }
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 50);
}

// Close add link modal
function closeAddLinkModal() {
    const modal = document.getElementById('addLinkModal');
    const content = document.getElementById('linkModalContent');
    
    if (!modal || !content) return;
    
    content.classList.add('scale-95', 'opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        resetLinkModal();
    }, 200);
}

// Reset add link modal to initial state
function resetLinkModal() {
    const container = document.getElementById('linkFieldsContainer');
    if (!container || !firstBlockHTML) return;

    // Clear container and add only one block
    container.innerHTML = firstBlockHTML;
    blockCounter = 0;
    
    // Reset the form
    const form = document.getElementById('addLinkForm');
    if (form) {
        form.reset();
    }

    // Reset tags for first block
    const tagsDisplay = document.getElementById('tags-display-0');
    const tagCount = document.querySelector('.tag-count');
    const tagsDropdown = document.getElementById('tags-dropdown-0');
    if (tagsDisplay) tagsDisplay.textContent = 'Select Opportunity Types';
    if (tagCount) tagCount.textContent = '0';
    if (tagsDropdown) {
        const checkboxes = tagsDropdown.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
    }
}

// Submit add link form
async function submitLinksForm() {
    const submitBtn = document.getElementById('submitLinksBtn');
    if (!submitBtn || submitBtn.disabled) return; // Prevent multiple submissions

    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    submitBtn.disabled = true;

    try {
        const linksData = collectLinksData();
        
        if (linksData.length === 0) {
            showNotification('error', 'Please add at least one link with a URL');
            return;
        }

        const result = await sendLinksData(linksData);
        
        if (result.success) {
            showNotification('success', result.message || 'Links added successfully!');
            closeAddLinkModal();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification('error', result.message || 'Error adding links');
        }
    } catch (error) {
        showNotification('error', 'Network error: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Collect links data properly (updated for custom multi-select)
function collectLinksData() {
    const blocks = document.querySelectorAll('.link-block');
    const linksData = [];
    
    blocks.forEach(block => {
        const url = block.querySelector('[name="link[]"]')?.value?.trim();
        
        // Only add if URL is provided
        if (url) {
            // Handle custom multi-select for tags
            const tagsDropdown = block.querySelector('[id^="tags-dropdown-"]');
            let tags = '';
            if (tagsDropdown) {
                const selectedCheckboxes = tagsDropdown.querySelectorAll('input[type="checkbox"]:checked');
                const selectedValues = Array.from(selectedCheckboxes).map(cb => cb.value).filter(v => v);
                tags = selectedValues.join(', ');
            }

            linksData.push({
                title: block.querySelector('[name="title[]"]')?.value?.trim() || '',
                url: url,
                description: block.querySelector('[name="description[]"]')?.value?.trim() || '',
                tags: tags,
            });
            
            // Remove validation error styling
            block.querySelector('[name="link[]"]')?.classList.remove('border-red-500');
        } else {
            // Add validation error styling
            block.querySelector('[name="link[]"]')?.classList.add('border-red-500');
        }
    });
    
    return linksData;
}

// Send add link data to server
async function sendLinksData(linksData) {
    const response = await fetch('{{ url_for("admin.admin_add_opportunity_link") }}', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ links: linksData })
    });
    
    return await response.json();
}

// Make functions globally available
window.openAddLinkModal = openAddLinkModal;
window.closeAddLinkModal = closeAddLinkModal;
window.addNewLinkBlock = addNewLinkBlock;
window.removeLinkBlock = removeLinkBlock;
window.toggleTagsDropdown = toggleTagsDropdown;
window.updateTagsCount = updateTagsCount;

// Simple notification function (replace with your notification system if available)
function showNotification(type, message) {
    // Example: Using a simple alert (replace with your notification system)
    alert(`${type.toUpperCase()}: ${message}`);
}
</script>

<style>
.modal-scroll {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.modal-scroll::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.modal-scroll::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.modal-scroll::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.modal-scroll::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Ensure the modal content doesn't grow beyond max height */
#linkModalContent {
    max-height: 90vh; /* Keep modal within 90% of viewport height */
    display: flex;
    flex-direction: column;
}

/* Make linkFieldsContainer scrollable */
#linkFieldsContainer {
    max-height: 60vh; /* Adjust this value based on your needs */
    overflow-y: auto;
    padding-right: 8px; /* Space for scrollbar */
}

/* Ensure the form and its container are flexible */
#addLinkForm {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Style for remove button */
.remove-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    color: #ef4444;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.remove-link:hover {
    background-color: #fef2f2;
    color: #b91c1c;
    border-color: #b91c1c;
}

/* Custom dropdown styles */
[id^="tags-dropdown-"] {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

[id^="tags-dropdown-"]::-webkit-scrollbar {
    width: 6px;
}

[id^="tags-dropdown-"]::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

[id^="tags-dropdown-"]::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

[id^="tags-dropdown-"]::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>