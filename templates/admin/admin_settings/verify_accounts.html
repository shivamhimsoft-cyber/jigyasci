<!-- Updated templates/admin/admin_settings/verify_accounts.html (with confirm alert before action) -->
{% extends "base.html" %}

{% block title %}Account Verification | Admin Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Flash Messages Popup (reused from adminfaculty.html for consistency) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" class="fixed top-4 right-4 z-50 w-80 max-w-full space-y-3">
                {% for category, message in messages %}
                    <div class="flex items-start p-4 rounded-lg shadow-lg border transition-all duration-300 transform 
                                {% if category == 'success' %}bg-green-100 border-green-300 text-green-800{% endif %}
                                {% if category == 'error' %}bg-red-100 border-red-300 text-red-800{% endif %}
                                {% if category == 'warning' %}bg-yellow-100 border-yellow-300 text-yellow-800{% endif %}
                                flash-message animate-slide-in">
                        <div class="flex-shrink-0">
                            {% if category == 'success' %}
                                <i class="ti ti-check text-xl"></i>
                            {% elif category == 'error' %}
                                <i class="ti ti-alert-circle text-xl"></i>
                            {% elif category == 'warning' %}
                                <i class="ti ti-alert-triangle text-xl"></i>
                            {% endif %}
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium">{{ message }}</p>
                        </div>
                        <button onclick="dismissMessage(this)" class="ml-2 p-1 hover:bg-opacity-20 rounded-full focus:outline-none">
                            <i class="ti ti-x text-lg"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="w-full card bg-white border border-gray-200 rounded-lg shadow-sm">
        <div class="card-body p-6">
            <div class="sm:flex items-center justify-between mb-6">
                <div>
                    <h5 class="text-xl font-semibold text-black mb-1">
                        <i class="fas fa-user-shield me-2"></i>Pending Scientist Verifications
                    </h5>
                    <p class="text-sm text-gray-600">All pending Scientist accounts awaiting verification</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 md:mt-0 mt-4">
                    <form class="relative">
                        <input type="text" id="search-input"
                               class="border border-black/80 rounded-sm px-4 py-1.5 pl-10 text-black placeholder-black/80 focus:ring-0 focus:outline-0 focus:border-black w-64"
                               placeholder="Search by email...">
                        <i class="ti ti-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </form>
                </div>
            </div>

            <div class="flex flex-col">
                <div id="table-container" class="overflow-auto cursor-grab">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">S. No.</th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-user-tag me-1"></i>User Type
                                </th>
                                <th scope="col" class="text-left px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-calendar me-1"></i>Created At
                                </th>
                                <th scope="col" class="text-center px-4 py-3 text-sm font-semibold text-black">
                                    <i class="fas fa-cogs me-1"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="verification-tbody" class="bg-white divide-y divide-gray-200">
                            {% if pending_pis %}
                                {% for user in pending_pis %}
                                <tr class="hover:bg-gray-50 transition-colors duration-150 verification-row" data-user-id="{{ user.id }}" data-email="{{ user.email }}">
                                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm text-black serial-no">
                                        {{ loop.index }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="max-w-xs">
                                            <span class="text-sm text-black line-clamp-2 email-cell">
                                                {{ user.email }}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="badge bg-warning text-dark px-2 py-1 rounded">{{ user.user_type }}</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="text-sm text-black">{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            <button onclick="handleAction('{{ user.id }}', 'accept')" 
                                                    class="accept-btn p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-colors duration-200" 
                                                    title="Accept">
                                                <i class="ti ti-check text-base"></i> Accept
                                            </button>
                                            <button onclick="handleAction('{{ user.id }}', 'reject')" 
                                                    class="reject-btn p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-200" 
                                                    title="Reject">
                                                <i class="ti ti-x text-base"></i> Reject
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr id="no-pending-row">
                                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="ti ti-shield-check text-4xl text-gray-300 mb-2"></i>
                                        <span class="text-sm">No pending verifications</span>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Footer Info -->
            <div class="text-center pt-3 border-t border-gray-200 text-muted small">
                <i class="fas fa-info-circle me-1"></i>Only Scientist accounts require manual verification. Other user types are auto-approved.
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for AJAX Actions, Search, and Animations (enhanced for no-reload) -->
<script>
    // Global counter for serial numbers
    let serialCounter = {{ pending_pis|length or 0 }};

    // AJAX Action Handler (fully without reload, with confirm alert)
    function handleAction(userId, action) {
        const row = document.querySelector(`.verification-row[data-user-id="${userId}"]`);
        if (!row) return;

        const email = row.dataset.email;
        const confirmMessage = `Are you sure you want to ${action} the account for ${email}?`;
        
        if (!confirm(confirmMessage)) {
            return; // Cancel if user clicks "Cancel"
        }

        const formData = new FormData();
        formData.append('action', action);

        // Show loading state on buttons
        const acceptBtn = row.querySelector('.accept-btn');
        const rejectBtn = row.querySelector('.reject-btn');
        const buttons = [acceptBtn, rejectBtn];
        buttons.forEach(btn => btn.disabled = true);

        const actionBtn = action === 'accept' ? acceptBtn : rejectBtn;
        const originalText = actionBtn.innerHTML;
        actionBtn.innerHTML = '<i class="ti ti-loader-2 animate-spin text-base"></i> Processing...';

        fetch(`/admin/verify_account/${userId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                showFlashMessage('success', `${action.charAt(0).toUpperCase() + action.slice(1)}ed ${email} successfully.`);
                
                // Animate and remove row
                row.style.transition = 'all 0.3s ease-out';
                row.style.opacity = '0';
                row.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    row.remove();
                    updateSerialNumbers(); // Update serial numbers for remaining rows
                    checkAndShowNoPending(); // Check if no rows left
                }, 300);
            } else {
                showFlashMessage('error', data.message || 'Action failed. Please try again.');
                resetButtons(buttons, actionBtn, originalText);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFlashMessage('error', 'Network error. Please try again.');
            resetButtons(buttons, actionBtn, originalText);
        });
    }

    // Reset buttons after error
    function resetButtons(buttons, actionBtn, originalText) {
        buttons.forEach(btn => btn.disabled = false);
        actionBtn.innerHTML = originalText;
    }

    // Update serial numbers after row removal
    function updateSerialNumbers() {
        const rows = document.querySelectorAll('.verification-row');
        rows.forEach((row, index) => {
            const serialCell = row.querySelector('.serial-no');
            if (serialCell) {
                serialCell.textContent = index + 1;
            }
        });
        serialCounter = rows.length;
    }

    // Check if no pending rows left and show message
    function checkAndShowNoPending() {
        const rows = document.querySelectorAll('.verification-row');
        const tbody = document.getElementById('verification-tbody');
        if (rows.length === 0) {
            tbody.innerHTML = `
                <tr id="no-pending-row">
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="ti ti-shield-check text-4xl text-gray-300 mb-2"></i>
                            <span class="text-sm">No pending verifications</span>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    // Search Functionality (client-side)
    document.getElementById('search-input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.verification-row');
        let visibleCount = 0;
        rows.forEach(row => {
            const email = row.querySelector('.email-cell').textContent.toLowerCase();
            if (email.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        // Update serial for visible rows if needed, but since search is temp, skip or handle separately
    });

    // Flash Message Functions (enhanced)
    function showFlashMessage(category, message) {
        const flashContainer = document.getElementById('flash-messages') || createFlashContainer();
        const flashDiv = document.createElement('div');
        flashDiv.className = `flash-message flex items-start p-4 rounded-lg shadow-lg border transition-all duration-300 transform animate-slide-in ${getFlashClasses(category)}`;
        flashDiv.innerHTML = `
            <div class="flex-shrink-0">
                ${getFlashIcon(category)}
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium">${message}</p>
            </div>
            <button onclick="dismissMessage(this)" class="ml-2 p-1 hover:bg-opacity-20 rounded-full focus:outline-none">
                <i class="ti ti-x text-lg"></i>
            </button>
        `;
        flashContainer.appendChild(flashDiv);
        setTimeout(() => dismissMessage(flashDiv.querySelector('button')), 5000);
    }

    function createFlashContainer() {
        const container = document.createElement('div');
        container.id = 'flash-messages';
        container.className = 'fixed top-4 right-4 z-50 w-80 max-w-full space-y-3';
        document.body.appendChild(container);
        return container;
    }

    function getFlashClasses(category) {
        const classes = {
            success: 'bg-green-100 border-green-300 text-green-800',
            error: 'bg-red-100 border-red-300 text-red-800',
            warning: 'bg-yellow-100 border-yellow-300 text-yellow-800'
        };
        return classes[category] || 'bg-blue-100 border-blue-300 text-blue-800';
    }

    function getFlashIcon(category) {
        const icons = {
            success: '<i class="ti ti-check text-xl"></i>',
            error: '<i class="ti ti-alert-circle text-xl"></i>',
            warning: '<i class="ti ti-alert-triangle text-xl"></i>'
        };
        return icons[category] || '<i class="ti ti-info-circle text-xl"></i>';
    }

    function dismissMessage(button) {
        const message = button.closest('.flash-message');
        message.classList.remove('animate-slide-in');
        message.classList.add('animate-slide-out');
        setTimeout(() => message.remove(), 300);
    }

    // Auto-dismiss existing messages
    document.addEventListener('DOMContentLoaded', () => {
        const messages = document.querySelectorAll('.flash-message');
        messages.forEach((message) => {
            setTimeout(() => dismissMessage({ closest: () => message }), 5000);
        });
    });

    // Table Drag Scroll
    const container = document.getElementById('table-container');
    let isDown = false;
    let startX;
    let scrollLeft;

    container.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isDown = true;
        container.classList.add('cursor-grabbing');
        container.classList.remove('cursor-grab');
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
        e.preventDefault();
    });

    container.addEventListener('mouseleave', () => {
        isDown = false;
        container.classList.remove('cursor-grabbing');
        container.classList.add('cursor-grab');
    });

    container.addEventListener('mouseup', () => {
        isDown = false;
        container.classList.remove('cursor-grabbing');
        container.classList.add('cursor-grab');
    });

    container.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 1;
        container.scrollLeft = scrollLeft - walk;
    });
</script>

<!-- Styles (reused and extended) -->
<style>
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    .animate-slide-out { animation: slideOut 0.3s ease-in forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    .flash-message { min-height: 3rem; display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .flash-message button:hover { background-color: rgba(0, 0, 0, 0.1); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .badge { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 0.25rem; }
    .verification-row { transition: all 0.3s ease-out; }
</style>
{% endblock %}