{% extends "base.html" %}
{% block title %}Account Verification | Admin Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="card bg-white border border-gray-200 rounded-lg shadow-sm">
        <div class="card-body p-6">
            <div class="sm:flex items-center justify-between mb-6">
                <div>
                    <h5 class="text-xl font-semibold text-black mb-1">Pending Scientist Verifications</h5>
                    <p class="text-sm text-gray-600">All pending Scientist accounts awaiting verification</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 mt-4 md:mt-0">
                    <input type="text" id="search-input"
                           class="border border-black/80 rounded-sm px-4 py-1.5 pl-10 text-black placeholder-black/80 focus:ring-0 focus:outline-0 focus:border-black w-64"
                           placeholder="Search by email or name...">
                    <i class="ti ti-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                </div>
            </div>

            <div class="overflow-auto cursor-grab" id="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">S.No.</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Email</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Full Name</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Institution</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Designation</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Bio</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-black">Created</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-black">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="verification-tbody" class="bg-white divide-y divide-gray-200">
                        {% if pending_pis %}
                            {% for user in pending_pis %}
                            {% set pi = user.profile.pi_profile if user.profile else none %}
                            <tr class="verification-row hover:bg-gray-50"
                                data-user-id="{{ user.id }}"
                                data-email="{{ user.email }}"
                                data-name="{{ pi.name if pi else '' }}">
                                <td class="px-4 py-3 text-center text-sm serial-no">{{ loop.index }}</td>
                                <td class="px-4 py-3"><span class="text-sm email-cell">{{ user.email }}</span></td>
                                <td class="px-4 py-3"><span class="text-sm">{{ pi.name or '—' }}</span></td>
                                <td class="px-4 py-3"><span class="text-sm">{{ pi.affiliation or '—' }}</span></td>
                                <td class="px-4 py-3"><span class="text-sm">{{ pi.current_designation or '—' }}</span></td>
                                <td class="px-4 py-3"><span class="text-sm line-clamp-2">{{ pi.current_message or '—' }}</span></td>
                                <td class="px-4 py-3 text-sm">{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="px-4 py-3 text-center">
                                    <button onclick="handleAction('{{ user.id }}', 'accept')"
                                            class="accept-btn p-2 text-green-600 hover:bg-green-50 rounded">Accept</button>
                                    <button onclick="handleAction('{{ user.id }}', 'reject')"
                                            class="reject-btn p-2 text-red-600 hover:bg-red-50 rounded">Reject</button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr id="no-pending-row">
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                <span class="text-sm">No pending verifications</span>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="text-center pt-3 border-t border-gray-200 text-muted text-sm">
                Only Scientist accounts require manual verification.
            </div>
        </div>
    </div>
</div>

<script>
function handleAction(userId, action) {
    const row = document.querySelector(`[data-user-id="${userId}"]`);
    if (!row) return;

    const email = row.dataset.email;
    const name = row.dataset.name || email;
    if (!confirm(`Are you sure you want to ${action} the account for ${name} (${email})?`)) return;

    const form = new FormData();
    form.append('action', action);

    const btn = row.querySelector(`.${action === 'accept' ? 'accept' : 'reject'}-btn`);
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Processing...';

    fetch(`/admin/verify_account/${userId}`, { method: 'POST', body: form })
    .then(r => r.json())
    .then(d => {
        showFlash(d.success ? 'success' : 'error', d.message);
        if (d.success) {
            row.style.opacity = 0;
            setTimeout(() => { row.remove(); updateSerial(); checkEmpty(); }, 300);
        } else {
            btn.innerHTML = orig; btn.disabled = false;
        }
    })
    .catch(() => { showFlash('error', 'Network error'); btn.innerHTML = orig; btn.disabled = false; });
}

function updateSerial() {
    document.querySelectorAll('.verification-row').forEach((r, i) => {
        r.querySelector('.serial-no').textContent = i + 1;
    });
}

function checkEmpty() {
    if (!document.querySelector('.verification-row')) {
        document.getElementById('verification-tbody').innerHTML = `
            <tr id="no-pending-row"><td colspan="8" class="px-4 py-8 text-center text-gray-500">
                <span class="text-sm">No pending verifications</span>
            </td></tr>`;
    }
}

function showFlash(type, msg) {
    const c = document.getElementById('flash-messages') || (function(){
        const d = document.createElement('div'); d.id='flash-messages';
        d.className='fixed top-4 right-4 z-50 space-y-2'; document.body.appendChild(d); return d;
    })();
    const e = document.createElement('div');
    e.className = `p-3 rounded text-white shadow-lg ${type==='success'?'bg-green-600':'bg-red-600'}`;
    e.innerHTML = `${msg} <button class="float-right" onclick="this.parentElement.remove()">×</button>`;
    c.appendChild(e);
    setTimeout(() => e.remove(), 5000);
}

// Search
document.getElementById('search-input').addEventListener('input', e => {
    const t = e.target.value.toLowerCase();
    document.querySelectorAll('.verification-row').forEach(r => {
        const email = r.dataset.email.toLowerCase();
        const name = (r.dataset.name||'').toLowerCase();
        r.style.display = (email.includes(t) || name.includes(t)) ? '' : 'none';
    });
});

// Drag scroll
const cont = document.getElementById('table-container');
let down = false, startX, scrollL;
cont.addEventListener('mousedown', e => { if(e.button===0){ down=true; startX=e.pageX-cont.offsetLeft; scrollL=cont.scrollLeft; cont.classList.replace('cursor-grab','cursor-grabbing');}});
cont.addEventListener('mouseleave', () => { down=false; cont.classList.replace('cursor-grabbing','cursor-grab'); });
cont.addEventListener('mouseup', () => { down=false; cont.classList.replace('cursor-grabbing','cursor-grab'); });
cont.addEventListener('mousemove', e => { if(!down) return; e.preventDefault(); const x=e.pageX-cont.offsetLeft; const w=(x-startX)*1; cont.scrollLeft=scrollL-w; });
</script>

<style>
.line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.verification-row { transition: opacity 0.3s; }
#search-input { position: relative; }
#search-input ~ i { pointer-events: none; }
</style>
{% endblock %}