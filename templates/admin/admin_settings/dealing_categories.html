<!-- templates\admin\admin_settings\dealing_categories.html -->

{% extends "admin/admin_settings/generic_model.html" %}

{% block admin_content %}
<div class="container-fluid px-4 py-6">
  <div class="bg-white shadow rounded-lg p-6">
    <div class="mb-6">
      <h4 class="text-xl font-semibold text-black">Manage Dealing Categories</h4>
      <p class="text-sm text-gray-600">Add or disable dealing categories</p>
    </div>

    <!-- Add Form -->
    <form method="POST" action="{{ url_for('admin.add_dealing_category') }}" class="mb-4">
      <div class="flex gap-3">
        <input
          type="text"
          name="name"
          placeholder="Add new dealing category"
          class="flex-grow border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary text-black"
          required
        >
        <select
          name="equipment_type_id"
          class="border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary text-black"
          required
        >
          <option value="" disabled selected>Select Equipment Type</option>
          {% for equipment_type in equipment_types %}
            <option value="{{ equipment_type.id }}">{{ equipment_type.name }}</option>
          {% endfor %}
        </select>
        <button
          type="submit"
          class="bg-black text-white px-5 py-2 rounded-md hover:bg-gray-800 transition whitespace-nowrap"
        >
          âž• Add
        </button>
      </div>
    </form>

    <!-- Table -->
    <div class="overflow-x-auto">
      <div class="relative" style="max-height: 60vh; overflow-y: auto;">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Equipment Type</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Created</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 text-black">
            {% for item in items %}
            <tr class="hover:bg-gray-50 {{ 'opacity-60' if item.status == 'Inactive' }}">
              <td class="px-4 py-4">{{ item.id }}</td>
              <td class="px-4 py-4">{{ item.name }}</td>
              <td class="px-4 py-4">{{ item.equipment_type.name if item.equipment_type else 'N/A' }}</td>
              <td class="px-4 py-4">
                <span class="inline-block px-2 py-1 text-xs font-medium rounded-full
                  {{ 'bg-green-100 text-green-800' if item.status == 'Active' else 'bg-red-100 text-red-800' }}">
                  {{ item.status }}
                </span>
              </td>
              <td class="px-4 py-4">{{ item.created_at.strftime('%Y-%m-%d') if item.created_at else 'N/A' }}</td>
              <td class="px-4 py-4">
                <div class="flex items-center gap-2">
                  <button onclick="toggleStatus('dealing_categories', {{ item.id }}, this)" 
                          class="inline-flex items-center gap-2 px-3 py-1 text-sm font-medium 
                                 {{ 'text-red-600 hover:text-red-800' if item.status == 'Active' else 'text-green-600 hover:text-green-800' }}">
                    <i class="ti {{ 'ti-ban' if item.status == 'Active' else 'ti-check' }}"></i>
                    {{ 'Disable' if item.status == 'Active' else 'Enable' }}
                  </button>
                  <button onclick="deleteItem('dealing_categories', {{ item.id }}, this)" 
                          class="inline-flex items-center gap-2 px-3 py-1 text-sm font-medium text-red-600 hover:text-red-800">
                    <i class="ti ti-trash"></i>
                    Delete
                  </button>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">No dealing categories found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Function to toggle status
function toggleStatus(modelName, itemId, buttonElement) {
    fetch(`/admin/${modelName}/toggle_status/${itemId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            const redirectUrl = response.url;
            if (redirectUrl.includes('/login')) {
                showNotification('Session expired. Please log in again.', 'error');
                return;
            }
            console.warn('Unexpected redirect:', redirectUrl);
            showNotification('Update applied, but redirect occurred.', 'warning');
            return;
        }
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            if (data.new_status === 'Active') {
                buttonElement.innerHTML = '<i class="ti ti-ban"></i> Disable';
                buttonElement.classList.remove('text-green-600', 'hover:text-green-800');
                buttonElement.classList.add('text-red-600', 'hover:text-red-800');
                const statusBadge = buttonElement.closest('tr').querySelector('td:nth-child(4) span');
                statusBadge.textContent = 'Active';
                statusBadge.classList.remove('bg-red-100', 'text-red-800');
                statusBadge.classList.add('bg-green-100', 'text-green-800');
                buttonElement.closest('tr').classList.remove('opacity-60');
            } else {
                buttonElement.innerHTML = '<i class="ti ti-check"></i> Enable';
                buttonElement.classList.remove('text-red-600', 'hover:text-red-800');
                buttonElement.classList.add('text-green-600', 'hover:text-green-800');
                const statusBadge = buttonElement.closest('tr').querySelector('td:nth-child(4) span');
                statusBadge.textContent = 'Inactive';
                statusBadge.classList.remove('bg-green-100', 'text-green-800');
                statusBadge.classList.add('bg-red-100', 'text-red-800');
                buttonElement.closest('tr').classList.add('opacity-60');
            }
            showNotification(data.message || 'Status updated successfully', 'success');
        } else {
            showNotification(data ? data.message || 'Update failed' : 'Unknown error', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating status: ' + error.message, 'error');
    });
}

// Function to delete item
function deleteItem(modelName, itemId, buttonElement) {
    if (!confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        return;
    }
    fetch(`/admin/${modelName}/delete/${itemId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (response.redirected) {
            const redirectUrl = response.url;
            if (redirectUrl.includes('/login')) {
                showNotification('Session expired. Please log in again.', 'error');
                return;
            }
            console.warn('Unexpected redirect:', redirectUrl);
            showNotification('Delete applied, but redirect occurred.', 'warning');
            return;
        }
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response');
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            const row = buttonElement.closest('tr');
            row.remove();
            showNotification(data.message || 'Item deleted successfully', 'success');
        } else {
            showNotification(data ? data.message || 'Delete failed' : 'Unknown error', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting item: ' + error.message, 'error');
    });
}

// Function to show notifications
function showNotification(message, type = 'info') {
    const bgClass = type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    'bg-yellow-500';
    const textClass = type === 'success' ? 'text-white' : 
                      type === 'error' ? 'text-white' : 
                      'text-white';
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 max-w-sm w-80 shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden ${bgClass}`;
    notification.innerHTML = `<div class="p-4">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="ti ${type === 'success' ? 'ti-check' : type === 'error' ? 'ti-alert-circle' : 'ti-info'} text-white mr-2"></i>
            </div>
            <div class="ml-3 w-0 flex-1 pt-0.5">
                <p class="text-sm font-medium ${textClass}">${message}</p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
                <button class="bg-white bg-opacity-20 rounded-full p-1 inline-flex text-white hover:bg-opacity-30" onclick="this.parentElement.parentElement.parentElement.remove()">
                    <span class="sr-only">Close</span>
                    <i class="ti ti-x h-4 w-4"></i>
                </button>
            </div>
        </div>
    </div>`;
    document.body.appendChild(notification);
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
