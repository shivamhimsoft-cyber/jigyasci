{% extends "authBase.html" %}

{% block title %}Login | JigyaSci{% endblock %}

{% block content %}
<div class="lg:w-5/12 w-full">
    <h2 class="font-bold text-3xl mb-3">Welcome to JigyaSci</h2>
    <p class="text-base text-dark dark:text-darklink mb-7 font-medium">Sign in to your account</p>

    <!-- SOCIAL LOGIN (Google + LinkedIn) -->
    <div class="grid grid-cols-2 gap-6 mb-7">
        <!-- Google -->
        <a href="{{ url_for('auth.login_google') }}"
           class="group border border-light-dark rounded-lg py-3 px-4 flex items-center justify-center text-dark dark:text-darklink font-medium hover:text-primary dark:hover:text-primary transition duration-200">
            <img src="{{ url_for('static', filename='assets/images/svgs/google-icon.svg') }}" alt="Google" class="w-5 h-5 me-2">
            <span class="hidden md:inline">Sign in with</span>
            <span class="ml-1">Google</span>
        </a>

        <!-- LinkedIn -->
        <a href="{{ url_for('auth.login_linkedin') }}"
           class="group border border-light-dark rounded-lg py-3 px-4 flex items-center justify-center text-dark dark:text-darklink font-medium hover:text-linkedin dark:hover:text-linkedin transition duration-200">
            <svg class="w-5 h-5 me-2 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.999 0h-16c-2.209 0-4 1.791-4 4v16c0 2.209 1.791 4 4 4h16c2.209 0 4-1.791 4-4v-16c0-2.209-1.791-4-4-4zM8.5 20h-3.5v-11h3.5v11zM6.75 7.75c-1.104 0-2-0.896-2-2s0.896-2 2-2 2 0.896 2 2-0.896 2-2 2zM20.5 20h-3.5v-6c0-1.435-0.026-3.281-2-3.281-2 0-2.308 1.562-2.308 3.172v6.109h-3.5v-11h3.35v1.5h0.05c0.467-0.886 1.608-1.82 3.31-1.82 3.541 0 4.2 2.332 4.2 5.367v6.453h-3.5z"/>
            </svg>
            <span class="hidden md:inline">Sign in with</span>
            <span class="ml-1">LinkedIn</span>
        </a>
    </div>

    <div class="flex items-center text-base before:flex-[1_1_0%] before:border-t before:border-border before:me-6 after:flex-[1_1_0%] after:border-t after:border-border after:ms-6 dark:text-white dark:before:border-darkborder dark:after:border-darkborder mb-7">
        or sign in with email
    </div>

    <!-- Login Form -->
    <form method="POST" action="" novalidate id="loginForm">
        {{ form.hidden_tag() }}
        <div class="flex flex-col gap-5">

            <!-- Email -->
            <div>
                {{ form.email.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                {% if form.email.errors %}
                    {{ form.email(class="form-control is-invalid rounded-full") }}
                    <div class="invalid-feedback text-red-500 text-sm mt-1">
                        {% for error in form.email.errors %}<span>{{ error }}</span>{% endfor %}
                    </div>
                {% else %}
                    {{ form.email(class="form-control rounded-full", placeholder="you@example.com") }}
                {% endif %}
            </div>

            <!-- Password -->
            <div>
                {{ form.password.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                {% if form.password.errors %}
                    {{ form.password(class="form-control is-invalid rounded-full") }}
                    <div class="invalid-feedback text-red-500 text-sm mt-1">
                        {% for error in form.password.errors %}<span>{{ error }}</span>{% endfor %}
                    </div>
                {% else %}
                    {{ form.password(class="form-control rounded-full", placeholder="••••••••") }}
                {% endif %}
            </div>

            <!-- Remember + Forgot -->
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    {{ form.remember_me(class="cursor-pointer") }}
                    {{ form.remember_me.label(class="text-sm text-dark dark:text-darklink") }}
                </div>
                <button type="button" id="forgotPasswordBtn"
                        class="text-sm text-primary font-medium hover:underline">
                    Forgot Password?
                </button>
            </div>

            <!-- Submit -->
            {{ form.submit(class="btn btn-primary py-3 w-full text-sm font-semibold rounded-full shadow-md hover:shadow-lg transition") }}

            <!-- Register Link -->
            <div class="text-center mt-4">
                <span class="text-sm text-dark dark:text-darklink">Don't have an account?</span>
                <a href="{{ url_for('auth.register') }}" class="text-sm text-primary font-medium ml-1 hover:underline">
                    Create one
                </a>
            </div>
        </div>
    </form>
</div>

<!-- FORGOT PASSWORD MODAL (unchanged) -->
<div id="forgotModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-md w-full transform transition-all scale-100">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Reset Password</h3>
            <button id="closeForgotModal" class="text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="forgotForm">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Enter your email address
                </label>
                <input type="email" id="forgotEmail" required
                       class="form-control rounded-lg w-full px-4 py-2.5 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent"
                       placeholder="you@example.com">
                <div id="forgotError" class="text-red-500 text-xs mt-1 hidden"></div>
            </div>

            <div class="flex gap-3">
                <button type="submit"
                        class="flex-1 btn btn-primary py-2.5 text-sm font-medium rounded-lg shadow hover:shadow-md transition">
                    <span id="resetSpinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                    Send Reset Link
                </button>
                <button type="button" id="cancelReset"
                        class="flex-1 btn btn-outline py-2.5 text-sm font-medium rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    Cancel
                </button>
            </div>
        </form>

        <div id="resetSuccess" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
            <p class="text-sm text-green-800 dark:text-green-200">
                <strong>Check your email!</strong> We've sent a password reset link.
            </p>
        </div>
    </div>
</div>

<!-- PENDING VERIFICATION MODAL -->
{% if show_pending_modal %}
<div id="pendingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-md w-full">
        <div class="flex items-center mb-4">
            <svg class="h-6 w-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="ml-3 text-lg font-semibold text-gray-900 dark:text-white">Account Verification Pending</h3>
        </div>
        <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
            Your Scientist account is under review. You will be notified via email within 24 hours.
        </p>
        <button id="closePendingModal"
                class="w-full btn btn-primary py-2.5 text-sm font-medium rounded-lg">
            OK, Got it
        </button>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Forgot Password Modal (unchanged)
    const forgotBtn = document.getElementById('forgotPasswordBtn');
    const forgotModal = document.getElementById('forgotModal');
    const closeModal = document.getElementById('closeForgotModal');
    const cancelBtn = document.getElementById('cancelReset');
    const forgotForm = document.getElementById('forgotForm');
    const forgotEmail = document.getElementById('forgotEmail');
    const forgotError = document.getElementById('forgotError');
    const resetSpinner = document.getElementById('resetSpinner');
    const resetSuccess = document.getElementById('resetSuccess');

    forgotBtn?.addEventListener('click', () => {
        forgotModal.classList.remove('hidden');
        forgotEmail.focus();
    });

    [closeModal, cancelBtn].forEach(btn => {
        btn?.addEventListener('click', () => {
            forgotModal.classList.add('hidden');
            forgotForm.reset();
            forgotError.classList.add('hidden');
            resetSuccess.classList.add('hidden');
        });
    });

    forgotModal?.addEventListener('click', e => {
        if (e.target === forgotModal) forgotModal.classList.add('hidden');
    });

    forgotForm?.addEventListener('submit', async e => {
        e.preventDefault();
        const email = forgotEmail.value.trim();
        if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
            showError('Invalid email address');
            return;
        }

        resetSpinner.classList.remove('hidden');
        forgotError.classList.add('hidden');

        try {
            const res = await fetch('/forgot_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();

            if (res.ok) {
                resetSuccess.classList.remove('hidden');
                forgotForm.querySelector('button[type="submit"]').disabled = true;
            } else {
                showError(data.error || 'Failed to send reset link');
            }
        } catch {
            showError('Network error. Try again.');
        } finally {
            resetSpinner.classList.add('hidden');
        }
    });

    function showError(msg) {
        forgotError.textContent = msg;
        forgotError.classList.remove('hidden');
    }

    // Pending Modal
    document.getElementById('closePendingModal')?.addEventListener('click', () => {
        document.getElementById('pendingModal')?.remove();
    });
});
</script>

<style>
    /* LinkedIn brand color */
    .text-linkedin { color: #0077b5; }
    .dark .text-linkedin { color: #0a66c2; }

    /* Smooth hover */
    .group:hover svg { transform: scale(1.1); }
    .group svg { transition: transform 0.2s ease; }

    /* Modal animation */
    #forgotModal > div, #pendingModal > div {
        animation: popIn 0.25s ease-out;
    }
    @keyframes popIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}