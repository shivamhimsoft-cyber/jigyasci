{% extends "authBase.html" %}
{% block title %}Register | JigyaSci{% endblock %}

{% block content %}
<div class="lg:w-5/12 w-full">
    <h2 class="font-bold text-3xl mb-3">Welcome to JigyaSci</h2>
    <p class="text-base text-dark dark:text-darklink mb-7 font-medium">Create an Account</p>

    <!-- SOCIAL LOGIN (Google + LinkedIn) -->
    <div class="grid grid-cols-2 gap-6 mb-7">
        <!-- Google -->
        <a href="{{ url_for('auth.login_google') }}"
           class="group border border-light-dark rounded-lg py-3 px-4 flex items-center justify-center text-dark dark:text-darklink font-medium hover:text-primary dark:hover:text-primary transition duration-200">
            <img src="{{ url_for('static', filename='assets/images/svgs/google-icon.svg') }}" alt="Google" class="w-5 h-5 me-2">
            <span class="hidden md:inline">Sign up with</span>
            <span class="ml-1">Google</span>
        </a>

        <!-- LinkedIn -->
        <a href="{{ url_for('auth.login_linkedin') }}"
           class="group border border-light-dark rounded-lg py-3 px-4 flex items-center justify-center text-dark dark:text-darklink font-medium hover:text-linkedin dark:hover:text-linkedin transition duration-200">
            <svg class="w-5 h-5 me-2 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19.999 0h-16c-2.209 0-4 1.791-4 4v16c0 2.209 1.791 4 4 4h16c2.209 0 4-1.791 4-4v-16c0-2.209-1.791-4-4-4zM8.5 20h-3.5v-11h3.5v11zM6.75 7.75c-1.104 0-2-0.896-2-2s0.896-2 2-2 2 0.896 2 2-0.896 2-2 2zM20.5 20h-3.5v-6c0-1.435-0.026-3.281-2-3.281-2 0-2.308 1.562-2.308 3.172v6.109h-3.5v-11h3.35v1.5h0.05c0.467-0.886 1.608-1.82 3.31-1.82 3.541 0 4.2 2.332 4.2 5.367v6.453h-3.5z"/>
            </svg>
            <span class="hidden md:inline">Sign up with</span>
            <span class="ml-1">LinkedIn</span>
        </a>
    </div>

    <!-- OR Divider -->
    <div class="flex items-center text-base before:flex-[1_1_0%] before:border-t before:border-border before:me-6 after:flex-[1_1_0%] after:border-t after:border-border after:ms-6 dark:text-white dark:before:border-darkborder dark:after:border-darkborder mb-7">
        or sign up with email
    </div>

    <!-- EMAIL FORM -->
    <form method="POST" novalidate id="registrationForm">
        {{ form.hidden_tag() }}
        <input type="hidden" name="user_type_frozen" id="userType_frozen" value="">

        <div class="flex flex-col gap-5 mt-7">

            <!-- USER TYPE -->
            <div>
                {{ form.user_type.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                {{ form.user_type(class="form-control rounded-full", id="userType", required=True) }}
                <div class="text-red-500 text-sm mt-1 hidden" id="userTypeError">Please select a user type.</div>
            </div>

            <!-- DYNAMIC FIELDS -->
            <div id="dynamicFields" class="hidden space-y-4">
                <div>
                    {{ form.full_name.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                    {{ form.full_name(class="form-control rounded-full", id="fullName", required=True) }}
                    <div class="text-red-500 text-sm mt-1 hidden" id="fullNameError">Full name is required.</div>
                </div>

                <!-- ORGANIZATION -->
                <div>
                    <label id="orgLabel" class="text-dark dark:text-darklink font-semibold mb-2 block">
                        Institution / Company
                    </label>
                    <div id="orgContainer">
                        {{ form.organization(class="form-control rounded-full", id="organization", required=True) }}
                    </div>
                    <div class="text-red-500 text-sm mt-1 hidden" id="orgError">This field is required.</div>
                </div>

                <!-- DESIGNATION -->
                <div>
                    {{ form.designation.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                    {{ form.designation(class="form-control rounded-full", id="designation", required=True) }}
                    <div class="text-red-500 text-sm mt-1 hidden" id="desigError">Designation is required.</div>
                </div>

                <!-- PHONE -->
                <div>
                    {{ form.phone.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                    {{ form.phone(class="form-control rounded-full", id="phone", placeholder="+91 9876543210") }}
                </div>
            </div>

            <!-- EMAIL -->
            <div id="emailSection" class="hidden">
                {{ form.email.label(class="text-dark dark:text-darklink font-semibold mb-2 block") }}
                {{ form.email(class="form-control rounded-full", id="emailField", required=True) }}
                <div id="emailError" class="text-red-500 text-sm mt-1 hidden"></div>
            </div>

            <!-- VERIFY EMAIL -->
            <div id="verifyBtnSection" class="hidden">
                <button type="button" id="verifyEmailBtn"
                        class="btn btn-primary py-3 w-full flex justify-center items-center text-sm font-medium">
                    <span id="emailSpinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                    Verify Email & Create Account
                </button>
            </div>

            <!-- OTP SECTION -->
            <div id="otpSection" class="hidden space-y-4">
                <div class="flex items-center gap-3">
                    <div class="flex-1">
                        <label class="text-dark dark:text-darklink font-semibold mb-2 block">Enter OTP</label>
                        <input type="text" id="otpInput" class="form-control rounded-full" maxlength="6" placeholder="123456" required>
                        <div id="otpError" class="text-red-500 text-sm mt-1 hidden"></div>
                    </div>
                    <div id="countdownTimer" class="text-sm font-medium text-gray-600 self-end pb-1">
                        <span id="timerMinutes">10</span>:<span id="timerSeconds">00</span>
                    </div>
                </div>

                <div id="resendSection" class="hidden text-center">
                    <button type="button" id="resendOtpBtn"
                            class="text-sm text-primary hover:underline font-medium">Resend OTP</button>
                </div>

                <button type="button" id="verifyOtpBtn"
                        class="btn btn-primary py-3 w-full flex justify-center items-center text-sm font-medium">
                    <span id="otpSpinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                    Verify OTP
                </button>
            </div>

            <!-- SUCCESS MODAL -->
            <div id="successModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full">
                    <div class="text-center">
                        <svg class="w-20 h-20 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Account Created!</h3>
                        <p id="modalMessage" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">
                            Check your email for login details.
                        </p>
                    </div>
                    <button onclick="window.location.href='{{ url_for('auth.login') }}'"
                            class="mt-6 btn btn-primary w-full py-3 text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        Go to Login
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const userType = document.getElementById('userType');
    const dynamicFields = document.getElementById('dynamicFields');
    const emailSection = document.getElementById('emailSection');
    const verifyBtnSection = document.getElementById('verifyBtnSection');
    const otpSection = document.getElementById('otpSection');
    const verifyEmailBtn = document.getElementById('verifyEmailBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtpBtn');
    const successModal = document.getElementById('successModal');
    const modalMessage = document.getElementById('modalMessage');
    const userTypeFrozen = document.getElementById('userType_frozen');
    const otpInput = document.getElementById('otpInput');
    const countdownTimer = document.getElementById('countdownTimer');
    const resendSection = document.getElementById('resendSection');
    const timerMinutes = document.getElementById('timerMinutes');
    const timerSeconds = document.getElementById('timerSeconds');
    const orgLabel = document.getElementById('orgLabel');
    const orgContainer = document.getElementById('orgContainer');

    let otpExpiryTime = null;
    let countdownInterval = null;

    userType.addEventListener('change', () => {
        if (userType.value) {
            dynamicFields.classList.remove('hidden');
            emailSection.classList.remove('hidden');
            verifyBtnSection.classList.remove('hidden');

            if (userType.value === 'Industry') {
                orgLabel.textContent = 'Industry Name';
                orgContainer.innerHTML = `
                    <input type="text" name="organization" id="organization" class="form-control rounded-full" placeholder="Enter Industry Name" required>
                `;
            } else {
                orgLabel.textContent = 'Institution / Company';
                orgContainer.innerHTML = `{{ form.organization(class="form-control rounded-full", id="organization", required=True) }}`;
            }
        }
    });

    function freezeAll() {
        userType.disabled = true;
        if (userTypeFrozen) userTypeFrozen.value = userType.value;
        ['fullName','organization','designation','phone','emailField'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.readOnly = true;
                el.classList.add('bg-gray-100','cursor-not-allowed','opacity-75');
            }
        });
    }

    function startCountdown() {
        clearInterval(countdownInterval);
        otpExpiryTime = Date.now() + 10 * 60 * 1000;
        countdownInterval = setInterval(() => {
            const diff = Math.floor((otpExpiryTime - Date.now()) / 1000);
            if (diff <= 0) {
                clearInterval(countdownInterval);
                otpInput.disabled = true;
                otpInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                countdownTimer.classList.add('text-red-600');
                timerMinutes.textContent = '00';
                timerSeconds.textContent = '00';
                resendSection.classList.remove('hidden');
                return;
            }
            const mins = String(Math.floor(diff / 60)).padStart(2, '0');
            const secs = String(diff % 60).padStart(2, '0');
            timerMinutes.textContent = mins;
            timerSeconds.textContent = secs;
        }, 1000);
    }

    verifyEmailBtn.addEventListener('click', async () => {
        if (!validateDynamicFields()) return;

        const email = document.getElementById('emailField')?.value.trim();
        const user_type = userType.value;
        if (!email || !user_type) return;

        const spinner = document.getElementById('emailSpinner');
        spinner.classList.remove('hidden');
        verifyEmailBtn.disabled = true;

        try {
            const res = await fetch('/send_otp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, user_type})
            });
            const data = await res.json();

            if (res.ok) {
                freezeAll();
                verifyBtnSection.classList.add('hidden');
                otpSection.classList.remove('hidden');
                otpInput.focus();
                startCountdown();
            } else {
                showError('emailError', data.error || 'Failed to send OTP');
            }
        } catch (e) {
            showError('emailError', 'Network error');
        } finally {
            spinner.classList.add('hidden');
            verifyEmailBtn.disabled = false;
        }
    });

    resendOtpBtn.addEventListener('click', async () => {
        const email = document.getElementById('emailField')?.value.trim();
        const user_type = userType.value;

        const spinner = document.createElement('span');
        spinner.className = 'animate-spin inline-block w-4 h-4 border-2 border-primary border-t-transparent rounded-full ml-2';
        resendOtpBtn.appendChild(spinner);
        resendOtpBtn.disabled = true;

        try {
            const res = await fetch('/send_otp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, user_type})
            });
            if (res.ok) {
                otpInput.disabled = false;
                otpInput.value = '';
                otpInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                resendSection.classList.add('hidden');
                countdownTimer.classList.remove('text-red-600');
                startCountdown();
            }
        } catch (e) {
            console.error(e);
        } finally {
            resendOtpBtn.disabled = false;
            spinner.remove();
        }
    });

    verifyOtpBtn.addEventListener('click', async () => {
        const otp = otpInput.value.trim();
        if (!otp || otp.length !== 6) {
            showError('otpError', 'Enter 6-digit OTP');
            return;
        }

        const spinner = document.getElementById('otpSpinner');
        spinner.classList.remove('hidden');
        verifyOtpBtn.disabled = true;

        const orgEl = document.getElementById('organization');
        const orgValue = orgEl.tagName === 'SELECT' ? orgEl.value : orgEl.value.trim();

        try {
            const res = await fetch('/auto_register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    otp,
                    email: document.getElementById('emailField')?.value.trim(),
                    user_type: userType.value,
                    full_name: document.getElementById('fullName')?.value,
                    organization: orgValue || null,
                    designation: document.getElementById('designation')?.value || null,
                    phone: document.getElementById('phone')?.value.trim() || null
                })
            });
            const data = await res.json();

            if (res.ok && data.success) {
                clearInterval(countdownInterval);
                if (userType.value === 'Scientist') {
                    modalMessage.innerHTML = `
                        Check your email for login details.<br>
                        <strong class="text-orange-600">Your account is awaiting admin verification. You will be notified within 24 hours.</strong>
                    `;
                } else {
                    modalMessage.textContent = 'Check your email for login details.';
                }
                successModal.classList.remove('hidden');
            } else {
                showError('otpError', data.message || 'Invalid OTP');
            }
        } catch (e) {
            showError('otpError', 'Network error');
        } finally {
            spinner.classList.add('hidden');
            verifyOtpBtn.disabled = false;
        }
    });

    function validateDynamicFields() {
        let valid = true;
        const fields = [
            { id: 'userType', error: 'userTypeError', msg: 'Please select a user type.' },
            { id: 'fullName', error: 'fullNameError', msg: 'Full name is required.' },
            { id: 'organization', error: 'orgError', msg: 'This field is required.' },
            { id: 'designation', error: 'desigError', msg: 'Designation is required.' }
        ];

        fields.forEach(f => {
            const el = document.getElementById(f.id);
            const err = document.getElementById(f.error);
            if (!el?.value.trim()) {
                err.textContent = f.msg;
                err.classList.remove('hidden');
                valid = false;
            } else {
                err.classList.add('hidden');
            }
        });
        return valid;
    }

    function showError(id, msg) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = msg;
            el.classList.remove('hidden');
        }
    }
});
</script>

<style>
    #successModal > div { animation: modalPop 0.3s ease-out forwards; }
    @keyframes modalPop {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}