<!-- templates\welcome.html -->
 
{% extends "frontBase.html" %}
{% block title %}Research Collaboration Platform | Home{% endblock %}

{% block nav_bar_width %}
lg:w-[60%] md:w-[90%] w-full lg:py-6 md:py-6 py-2
{% endblock %}
{% block footer_width %}
lg:w-[60%] md:w-[90%] w-full
{% endblock %}

{% block content %}
<form id="search-form" class="lg:w-[60%] md:w-[90%] w-full flex flex-col mx-auto items-center px-4">
    <div><img src="../static/images/logo-shade_blue.png" class="lg:h-[100px] md:h-[100px] h-[80px] w-auto " alt=""></div>
    <div class="flex flex-wrap w-full gap-2">
        <button id="tab-PI-profile" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'PI-profile' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="PI-profile">PI Profile</button>
        <button id="tab-Student" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'Student' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="Student">Student</button>
        <button id="tab-Vendor" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'Vendor' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="Vendor">Vendor</button>
        <button id="tab-Industry" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'Industry' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="Industry">Industry</button>
        <button id="tab-Research-Facilities" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'Research-Facilities' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="Research-Facilities">Research Facilities</button>
        <button id="tab-Publication" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'Publication' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="Publication">Publications</button>
        <button id="tab-technologies" class="tab-button px-4 py-1 rounded-full font-bold border-[2px] hover:bg-primary/70 hover:border-secondary/50 transition ease-in duration-2000 {% if active_tab == 'technologies' %}bg-primary text-secondary/70 border-secondary/60{% else %}bg-white text-secondary/90 border-secondary/60{% endif %}" data-tab="technologies">Technologies</button>
    </div>

    <div class="border-[1px] border-secondary rounded-full w-full py-2 pr-3 pl-10 gap-4 mt-4 flex items-center relative">
        <i class="fa fa-search absolute left-6 top-[50%] translate-y-[-50%] text-secondary text-lg"></i>
        <input type="text" name="query" value="{{ query }}" class="w-full rounded-full border-0 bg-[#faf7f9] focus:outline-none focus:ring-0 text-secondary font-semibold" placeholder="Search with Name / Institute / Location / Research Area">
        <button type="submit" class="w-max h-full flex gap-2 items-center px-6 py-2 text-secondary bg-primary/70 font-semibold rounded-full text-lg border border-primary hover:bg-primary transition ease-in duration-200">
            <i class="fa fa-search"></i> <span class="hidden font-bold lg:block">Search...</span>
        </button>
    </div>
    <div id="tab-data" data-active-tab="{{ (active_tab or '').replace(' ', '-') }}"></div>

    <!-- Results Container -->
    <div id="results-container" class="w-full">
        <!-- Results will be loaded here via AJAX -->
        {% include 'partials/search_results.html' %}
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize active tab
    const tabData = document.getElementById('tab-data');
    const activeTab = tabData?.dataset?.activeTab || window.location.hash.substring(1);
    if (activeTab) {
        setTimeout(() => switchTab(activeTab), 300);
    }

    // Tab switching function
    function switchTab(tab) {
        const normalizedTab = tab.replace(/ /g, '-');
        
        // Update tab button styles
        document.querySelectorAll('.tab-button').forEach(b => {
            b.classList.remove('bg-primary', 'text-secondary/70', 'border-secondary/60');
            b.classList.add('bg-white', 'text-secondary/90', 'border-secondary/60');
        });

        const activeBtnSelectors = [
            `#tab-${normalizedTab}`,
            `#tab-${tab.replace(/-/g, ' ')}`
        ];
        
        for (const selector of activeBtnSelectors) {
            const activeBtn = document.querySelector(selector);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-secondary/90', 'border-secondary/60');
                activeBtn.classList.add('bg-primary', 'text-secondary/70', 'border-secondary/60');
                break;
            }
        }

        // Update URL hash
        window.location.hash = tab;
        
        // Trigger search if there's a query
        const query = document.querySelector('input[name="query"]').value;
        if (query) {
            performSearch(query, tab);
        }
    }

    // Tab button click handlers
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const tab = btn.dataset.tab;
            switchTab(tab);
        });
    });

    // Form submission handler
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.querySelector('input[name="query"]').value;
        const activeTab = document.querySelector('.tab-button.bg-primary').dataset.tab;
        performSearch(query, activeTab);
    });

    // Show more button handler (event delegation)
    document.getElementById('results-container').addEventListener('click', function(e) {
        if (e.target.classList.contains('show-more-btn')) {
            e.preventDefault();
            const tab = document.querySelector('.tab-button.bg-primary').dataset.tab;
            const query = document.querySelector('input[name="query"]').value;
            const currentLimit = parseInt(e.target.dataset.currentLimit) + 5;
            performSearch(query, tab, currentLimit);
        }
    });

    // AJAX search function
    function performSearch(query, activeTab, limit = 5) {
        const formData = new FormData();
        formData.append('query', query);
        formData.append('active_tab', activeTab);
        formData.append('limit', limit);

        fetch('/search', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('results-container').innerHTML = html;
            // Smooth scroll to results
            document.getElementById('results-container').scrollIntoView({
                behavior: 'smooth'
            });
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Search Error',
                text: 'An error occurred while performing the search. Please try again.'
            });
            console.error('Error:', error);
        });
    }
});
</script>
{% endblock %}